package main

import (
	"flag"
	"fmt"
	"path/filepath"

	"google.golang.org/protobuf/compiler/protogen"
	"google.golang.org/protobuf/types/pluginpb"
)

type pkgSummary struct {
	GoImportPath  protogen.GoImportPath
	GoPackageName protogen.GoPackageName
	// è¿™é‡Œç›´æ¥æ”¶é›† serviceDescï¼Œå°±èƒ½æ‹¿åˆ° ServiceName
	Services    []*serviceDesc
	FileDirName string
}

func main() {
	showVersion := flag.Bool("version", false, "print the version and exit")
	flag.Parse()
	if *showVersion {
		fmt.Printf("protoc-gen-kratos-foundation-client %v\n", Version)
		return
	}

	var flags flag.FlagSet

	protogen.Options{
		ParamFunc: flags.Set,
	}.Run(func(gen *protogen.Plugin) error {
		gen.SupportedFeatures = uint64(pluginpb.CodeGeneratorResponse_FEATURE_PROTO3_OPTIONAL)

		pkgs := map[protogen.GoImportPath]*pkgSummary{}

		for _, f := range gen.Files {
			if !f.Generate {
				continue
			}
			fd := generateFile(gen, f)
			if fd == nil || len(f.Services) == 0 {
				continue
			}

			// æŒ‰ GoImportPath åˆ†ç»„ï¼Œç›¸åŒç›®å½•å°±ä¼šæ±‡æ€»åˆ°ä¸€èµ·
			sum := pkgs[f.GoImportPath]
			if sum == nil {
				sum = &pkgSummary{
					GoImportPath:  f.GoImportPath,
					GoPackageName: f.GoPackageName,
					FileDirName:   filepath.Dir(f.Desc.Path()),
				}
				pkgs[f.GoImportPath] = sum
			}
			sum.Services = append(sum.Services, fd.Services...)
		}

		// ğŸ”¥ å…¨éƒ¨æ–‡ä»¶éƒ½å¤„ç†å®Œä¹‹åï¼Œå†é’ˆå¯¹æ¯ä¸ªåŒ…ç”Ÿæˆä¸€ä¸ª wire.go
		for _, sum := range pkgs {
			generateWireFile(gen, sum)
		}

		return nil
	})
}

func generateWireFile(gen *protogen.Plugin, sum *pkgSummary) {
	// æ–‡ä»¶åéšä¾¿ï¼Œä½ æƒ³å« wire.go ä¹Ÿ OKï¼Œ
	// ä½†å»ºè®®å¸¦ç‚¹åç¼€é¿å…å’Œæ‰‹å†™æ–‡ä»¶å†²çªï¼Œæ¯”å¦‚ wire_client_gen.goã€‚
	g := gen.NewGeneratedFile(sum.FileDirName+"/client_wire.go", sum.GoImportPath)

	g.P("// Code generated by protoc-gen-kratos-foundation-client. DO NOT EDIT.")
	g.P("// source: wire_client_gen.go (aggregated providers)")
	g.P()
	g.P("package ", sum.GoPackageName)
	g.P()
	g.P("import (")
	g.P(`    "github.com/google/wire"`)
	g.P(")")
	g.P()

	g.P("var ServiceClientProviderSet = wire.NewSet(")
	for _, svc := range sum.Services {
		// æŒ‰ä½ ç°åœ¨çš„è§„èŒƒï¼Œæ„é€ å‡½æ•°æ˜¯ New<ServiceName>ClientImpl
		g.P(fmt.Sprintf("    New%sClientImpl,", svc.ServiceName))
	}
	g.P(")")
}
