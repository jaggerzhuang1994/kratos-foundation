{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://github.com/jaggerzhuang1994/kratos-foundation/config.schema.json",
  "title": "Kratos Foundation Configuration",
  "description": "Kratos Foundation 框架配置 JSON Schema",
  "type": "object",
  "properties": {
    "app": {
      "type": "object",
      "description": "应用组件配置",
      "properties": {
        "disable_registrar": {
          "type": "boolean",
          "description": "是否禁用服务注册",
          "default": false
        },
        "registrar_timeout": {
          "type": "string",
          "description": "注册中心超时时间",
          "default": "10s",
          "examples": ["10s", "30s", "1m"]
        },
        "stop_timeout": {
          "type": "string",
          "description": "应用停止超时时间（必须大于 server.stop_delay）",
          "default": "30s",
          "examples": ["30s", "1m"]
        }
      }
    },
    "log": {
      "type": "object",
      "description": "日志组件配置",
      "properties": {
        "level": {
          "type": "string",
          "description": "最小日志级别",
          "enum": ["debug", "info", "warn", "error"],
          "default": "info"
        },
        "filter_empty": {
          "type": "boolean",
          "description": "是否过滤掉空值的 kv",
          "default": true
        },
        "filter_keys": {
          "type": "array",
          "description": "打印日志时过滤的字段",
          "items": { "type": "string" },
          "default": [],
          "examples": [["password", "token", "secret"]]
        },
        "time_format": {
          "type": "string",
          "description": "时间格式化（Go time format）",
          "default": "2006-01-02T15:04:05Z07:00"
        },
        "preset": {
          "type": "array",
          "description": "预置的日志字段",
          "items": {
            "type": "string",
            "enum": ["ts", "service.id", "service.name", "service.version", "trace.id", "span.id", "caller"]
          },
          "default": ["ts", "service.id", "service.name", "service.version", "trace.id", "span.id", "caller"]
        },
        "std": {
          "type": "object",
          "description": "标准输出日志配置",
          "properties": {
            "disable": {
              "type": "boolean",
              "description": "是否禁用标准输出日志",
              "default": false
            },
            "level": {
              "type": "string",
              "description": "最小日志级别（继承上层）",
              "enum": ["debug", "info", "warn", "error"]
            },
            "filter_empty": {
              "type": "boolean",
              "description": "是否过滤掉空值的 kv"
            },
            "filter_keys": {
              "type": "array",
              "description": "过滤的字段（会合并上层）",
              "items": { "type": "string" }
            }
          }
        },
        "file": {
          "type": "object",
          "description": "文件日志配置",
          "properties": {
            "disable": {
              "type": "boolean",
              "description": "是否禁用文件日志",
              "default": false
            },
            "level": {
              "type": "string",
              "description": "最小日志级别（继承上层）",
              "enum": ["debug", "info", "warn", "error"]
            },
            "filter_empty": {
              "type": "boolean",
              "description": "是否过滤掉空值的 kv"
            },
            "filter_keys": {
              "type": "array",
              "description": "过滤的字段（会合并上层）",
              "items": { "type": "string" }
            },
            "path": {
              "type": "string",
              "description": "日志文件路径",
              "default": "./app.log"
            },
            "rotating": {
              "type": "object",
              "description": "日志轮转配置",
              "properties": {
                "disable": {
                  "type": "boolean",
                  "description": "是否禁用日志轮转",
                  "default": false
                },
                "max_size": {
                  "type": "integer",
                  "description": "单个日志文件最大大小（MB）",
                  "default": 100
                },
                "max_file_age": {
                  "type": "integer",
                  "description": "保留旧日志文件的最大天数"
                },
                "max_files": {
                  "type": "integer",
                  "description": "保留的旧日志文件最大数量"
                },
                "local_time": {
                  "type": "boolean",
                  "description": "备份文件名时间戳是否使用本地时间",
                  "default": false
                },
                "compress": {
                  "type": "boolean",
                  "description": "轮转后的日志文件是否使用 gzip 压缩",
                  "default": false
                }
              }
            }
          }
        }
      }
    },
    "metrics": {
      "type": "object",
      "description": "指标监控组件配置",
      "properties": {
        "meter_name": {
          "type": "string",
          "description": "指标命名空间（默认为应用名）"
        },
        "counter_map_size": {
          "type": "integer",
          "description": "counter map 初始容量",
          "default": 64
        },
        "gauge_map_size": {
          "type": "integer",
          "description": "gauge map 初始容量",
          "default": 64
        },
        "histogram_map_size": {
          "type": "integer",
          "description": "histogram map 初始容量",
          "default": 64
        },
        "log": { "$ref": "#/$defs/moduleLog" }
      }
    },
    "tracing": {
      "type": "object",
      "description": "分布式追踪组件配置",
      "properties": {
        "disable": {
          "type": "boolean",
          "description": "是否禁用链路追踪",
          "default": false
        },
        "tracer_name": {
          "type": "string",
          "description": "默认 tracer name（默认为应用名）"
        },
        "exporter": {
          "type": "object",
          "description": "导出配置",
          "properties": {
            "endpoint_url": {
              "type": "string",
              "description": "导出端点 URL",
              "examples": ["http://localhost:4317", "http://jaeger:14268/api/traces"]
            },
            "compression": {
              "type": "string",
              "description": "压缩方式",
              "enum": ["NO", "GZIP"],
              "default": "NO"
            },
            "headers": {
              "type": "object",
              "description": "HTTP headers",
              "additionalProperties": { "type": "string" }
            },
            "timeout": {
              "type": "string",
              "description": "超时时间",
              "examples": ["10s", "30s"]
            },
            "retry": {
              "type": "object",
              "description": "重试配置",
              "properties": {
                "enabled": {
                  "type": "boolean",
                  "description": "是否启用重试"
                },
                "initial_interval": {
                  "type": "string",
                  "description": "初始重试间隔"
                },
                "max_interval": {
                  "type": "string",
                  "description": "最大重试间隔"
                },
                "max_elapsed_time": {
                  "type": "string",
                  "description": "最大重试总时间"
                }
              }
            }
          }
        },
        "sampler": {
          "type": "object",
          "description": "采样率配置",
          "properties": {
            "sample": {
              "type": "string",
              "description": "采样模式",
              "enum": ["RATIO", "ALWAYS", "NEVER"],
              "default": "RATIO"
            },
            "ratio": {
              "type": "number",
              "description": "采样率（0-1）",
              "default": 0.05,
              "minimum": 0,
              "maximum": 1
            }
          }
        },
        "log": { "$ref": "#/$defs/moduleLog" }
      }
    },
    "server": {
      "type": "object",
      "description": "服务器组件配置",
      "properties": {
        "stop_delay": {
          "type": "string",
          "description": "停止延迟（支持服务发现延迟）",
          "examples": ["5s", "10s"]
        },
        "log": { "$ref": "#/$defs/moduleLog" },
        "http": {
          "type": "object",
          "description": "HTTP 服务器配置",
          "properties": {
            "disable": {
              "type": "boolean",
              "description": "是否禁用 HTTP 服务器",
              "default": false
            },
            "network": {
              "type": "string",
              "description": "网络类型",
              "enum": ["tcp", "tcp4", "tcp6", "unix", "unixpacket"],
              "default": "tcp"
            },
            "addr": {
              "type": "string",
              "description": "监听地址 host:port",
              "examples": ["0.0.0.0:8080", ":8080", "/var/run/app.sock"]
            },
            "endpoint": { "$ref": "#/$defs/endpoint" },
            "disable_strict_slash": {
              "type": "boolean",
              "description": "禁用 strictSlash",
              "default": false
            },
            "path_prefix": {
              "type": "string",
              "description": "HTTP 路由前缀",
              "examples": ["/api", "/v1"]
            },
            "metrics": {
              "type": "object",
              "description": "Metrics 路由配置",
              "properties": {
                "disable": {
                  "type": "boolean",
                  "description": "是否禁用 metrics 路由",
                  "default": false
                },
                "path": {
                  "type": "string",
                  "description": "metrics 路由路径",
                  "default": "/metrics"
                }
              }
            }
          }
        },
        "grpc": {
          "type": "object",
          "description": "gRPC 服务器配置",
          "properties": {
            "disable": {
              "type": "boolean",
              "description": "是否禁用 gRPC 服务器",
              "default": false
            },
            "network": {
              "type": "string",
              "description": "网络类型",
              "enum": ["tcp", "tcp4", "tcp6", "unix"],
              "default": "tcp"
            },
            "addr": {
              "type": "string",
              "description": "监听地址 host:port",
              "examples": ["0.0.0.0:9090", ":9090"]
            },
            "endpoint": { "$ref": "#/$defs/endpoint" },
            "custom_health": {
              "type": "boolean",
              "description": "是否自定义健康检查",
              "default": false
            },
            "disable_reflection": {
              "type": "boolean",
              "description": "是否禁用服务反射",
              "default": false
            }
          }
        },
        "middleware": { "$ref": "#/$defs/serverMiddleware" }
      }
    },
    "database": {
      "type": "object",
      "description": "数据库组件配置",
      "properties": {
        "default": {
          "type": "string",
          "description": "默认连接名"
        },
        "connections": {
          "type": "object",
          "description": "数据库连接配置",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "driver": {
                "type": "string",
                "description": "数据库驱动",
                "default": "mysql",
                "examples": ["mysql", "postgres", "sqlite"]
              },
              "dsn": {
                "type": "string",
                "description": "数据源名称（DSN）"
              },
              "replicas": {
                "type": "array",
                "description": "从库配置（读写分离）",
                "items": {
                  "type": "object",
                  "properties": {
                    "driver": { "type": "string" },
                    "dsn": { "type": "string" }
                  },
                  "required": ["dsn"]
                }
              },
              "datas": {
                "type": "array",
                "description": "自动切换数据源关联表",
                "items": { "type": "string" }
              },
              "trace_resolver_mode": {
                "type": "boolean",
                "description": "打印 sources/replicas 模式日志",
                "default": false
              }
            },
            "required": ["dsn"]
          }
        },
        "gorm": {
          "type": "object",
          "description": "GORM 配置",
          "properties": {
            "skip_default_transaction": {
              "type": "boolean",
              "description": "跳过默认事务",
              "default": false
            },
            "default_transaction_timeout": {
              "type": "string",
              "description": "默认事务超时"
            },
            "default_context_timeout": {
              "type": "string",
              "description": "默认上下文超时"
            },
            "full_save_associations": {
              "type": "boolean",
              "description": "完整保存关联",
              "default": false
            },
            "logger": {
              "type": "object",
              "description": "GORM 日志配置",
              "properties": {
                "level": {
                  "type": "string",
                  "description": "日志级别",
                  "enum": ["SILENT", "ERROR", "WARN", "INFO"],
                  "default": "WARN"
                },
                "slow_threshold": {
                  "type": "string",
                  "description": "慢日志阈值",
                  "examples": ["200ms", "1s"]
                },
                "colorful": {
                  "type": "boolean",
                  "description": "是否彩色输出",
                  "default": false
                },
                "ignore_record_not_found_error": {
                  "type": "boolean",
                  "description": "忽略记录未找到错误",
                  "default": false
                },
                "parameterized_queries": {
                  "type": "boolean",
                  "description": "参数化查询",
                  "default": false
                }
              }
            },
            "disable_automatic_ping": { "type": "boolean" },
            "disable_foreign_key_constraint_when_migrating": { "type": "boolean" },
            "ignore_relationships_when_migrating": { "type": "boolean" },
            "disable_nested_transaction": { "type": "boolean" },
            "allow_global_update": { "type": "boolean" },
            "query_fields": { "type": "boolean" },
            "create_batch_size": { "type": "integer" },
            "translate_error": { "type": "boolean" },
            "propagate_unscoped": { "type": "boolean" }
          }
        },
        "tracing": {
          "type": "object",
          "description": "数据库追踪配置",
          "properties": {
            "disable": { "type": "boolean", "default": false },
            "exclude_query_vars": { "type": "boolean", "description": "排除 SQL 变量部分" },
            "exclude_metrics": { "type": "boolean", "description": "排除 DBStats 指标" },
            "record_stack_trace_in_span": { "type": "boolean", "description": "异常事件包含堆栈追踪" },
            "exclude_server_address": { "type": "boolean", "description": "排除 db.server_address" }
          }
        },
        "log": { "$ref": "#/$defs/moduleLog" }
      }
    },
    "redis": {
      "type": "object",
      "description": "Redis 组件配置",
      "properties": {
        "default": {
          "type": "string",
          "description": "默认连接名"
        },
        "connections": {
          "type": "object",
          "description": "Redis 连接配置",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "network": { "type": "string", "enum": ["tcp", "unix"], "default": "tcp" },
              "addr": { "type": "string", "description": "地址 host:port" },
              "client_name": { "type": "string", "description": "客户端名称" },
              "protocol": { "type": "integer", "enum": [2, 3], "default": 3, "description": "RESP 协议版本" },
              "username": { "type": "string" },
              "password": { "type": "string" },
              "db": { "type": "integer", "default": 0 },
              "max_retries": { "type": "integer", "default": 3, "description": "最大重试次数（-1 禁用）" },
              "min_retry_backoff": { "type": "string", "default": "8ms" },
              "max_retry_backoff": { "type": "string", "default": "512ms" },
              "dial_timeout": { "type": "string", "default": "5s" },
              "dialer_retries": { "type": "integer", "default": 5 },
              "dialer_retry_timeout": { "type": "string", "default": "100ms" },
              "read_timeout": { "type": "string", "default": "3s" },
              "write_timeout": { "type": "string", "default": "3s" },
              "context_timeout_enabled": { "type": "boolean", "default": false },
              "read_buffer_size": { "type": "integer", "default": 32768 },
              "write_buffer_size": { "type": "integer", "default": 32768 },
              "pool_fifo": { "type": "boolean", "default": false, "description": "true=FIFO, false=LIFO" },
              "pool_size": { "type": "integer", "description": "连接池大小（默认 10*GOMAXPROCS）" },
              "max_concurrent_dials": { "type": "integer" },
              "pool_timeout": { "type": "string", "description": "默认 ReadTimeout+1s" },
              "min_idle_conns": { "type": "integer", "default": 0 },
              "max_idle_conns": { "type": "integer", "default": 0 },
              "max_active_conns": { "type": "integer", "default": 0, "description": "0=无限制" },
              "conn_max_idle_time": { "type": "string", "default": "30m" },
              "conn_max_lifetime": { "type": "string", "default": "0", "description": "0=无限制" },
              "read_only": { "type": "boolean", "default": false },
              "disable_identity": { "type": "boolean", "default": false },
              "identity_suffix": { "type": "string" },
              "unstable_resp3": { "type": "boolean", "default": false },
              "failing_timeout_seconds": { "type": "integer", "default": 15 }
            },
            "required": ["addr"]
          }
        },
        "tracing": {
          "type": "object",
          "properties": {
            "disable": { "type": "boolean", "default": false },
            "db_statement": { "type": "boolean", "description": "记录 redis 命令" },
            "caller_enabled": { "type": "boolean", "description": "记录调用位置" },
            "dial_filter": { "type": "boolean", "description": "启用拨号过滤" }
          }
        },
        "metrics": {
          "type": "object",
          "properties": {
            "disable": { "type": "boolean", "default": false }
          }
        },
        "log": { "$ref": "#/$defs/moduleLog" }
      }
    },
    "client": {
      "type": "object",
      "description": "客户端组件配置",
      "properties": {
        "clients": {
          "type": "object",
          "description": "客户端配置",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "protocol": {
                "type": "string",
                "description": "协议",
                "enum": ["GRPC", "HTTP", "GRPCS", "HTTPS"],
                "default": "GRPC"
              },
              "target": {
                "type": "string",
                "description": "目标端点（支持服务发现或直连）",
                "examples": ["discovery:///user-service", "localhost:9090", "https://api.example.com"]
              },
              "middleware": { "$ref": "#/$defs/clientMiddleware" }
            }
          }
        },
        "log": { "$ref": "#/$defs/moduleLog" }
      }
    },
    "job": {
      "type": "object",
      "description": "定时任务组件配置",
      "properties": {
        "disable": {
          "type": "boolean",
          "description": "是否禁用任务组件",
          "default": false
        },
        "timezone": {
          "type": "string",
          "description": "cron 时区（默认当前时区）",
          "examples": ["Asia/Shanghai", "UTC", "America/New_York"]
        },
        "jobs": {
          "type": "object",
          "description": "任务定义",
          "additionalProperties": {
            "type": "object",
            "properties": {
              "disable": {
                "type": "boolean",
                "description": "是否禁用任务",
                "default": false
              },
              "schedule": {
                "type": "string",
                "description": "定时表达式：cron / @yearly/@monthly/@weekly/@daily/@hourly / @every {duration}",
                "examples": [
                  "0 */6 * * *",
                  "0 0 2 * * *",
                  "TZ=Asia/Tokyo 0 * * * *",
                  "@daily",
                  "@every 30s",
                  "@every 1m30s"
                ]
              },
              "concurrent_policy": {
                "type": "string",
                "description": "任务并行策略",
                "enum": ["OVERLAP", "DELAY", "SKIP"],
                "default": "OVERLAP"
              },
              "immediately": {
                "type": "boolean",
                "description": "启动时立即执行一次",
                "default": false
              }
            }
          }
        },
        "tracing": {
          "type": "object",
          "properties": {
            "disable": { "type": "boolean", "default": false },
            "tracer_name": { "type": "string" }
          }
        },
        "metrics": {
          "type": "object",
          "properties": {
            "disable": { "type": "boolean", "default": false },
            "meter_name": { "type": "string" }
          }
        },
        "log": { "$ref": "#/$defs/moduleLog" }
      }
    }
  },
  "$defs": {
    "moduleLog": {
      "type": "object",
      "description": "模块日志配置",
      "properties": {
        "level": {
          "type": "string",
          "enum": ["debug", "info", "warn", "error"]
        },
        "filter_empty": { "type": "boolean" },
        "filter_keys": {
          "type": "array",
          "items": { "type": "string" }
        }
      }
    },
    "endpoint": {
      "type": "object",
      "description": "端点配置",
      "properties": {
        "scheme": {
          "type": "string",
          "examples": ["http", "https", "grpc", "grpcs"]
        },
        "host": {
          "type": "string",
          "examples": ["localhost:8080", "api.example.com"]
        }
      }
    },
    "timeout": {
      "type": "object",
      "description": "超时中间件配置",
      "properties": {
        "default": {
          "type": "string",
          "description": "默认超时时间",
          "examples": ["1s", "2s", "5s"]
        },
        "routes": {
          "type": "array",
          "description": "路由级超时规则",
          "items": {
            "type": "object",
            "properties": {
              "path": { "type": "string", "description": "精确路径匹配" },
              "prefix": { "type": "string", "description": "前缀匹配" },
              "timeout": { "type": "string" }
            }
          }
        }
      }
    },
    "metadata": {
      "type": "object",
      "description": "Metadata 中间件配置",
      "properties": {
        "disable": { "type": "boolean", "default": false },
        "prefix": {
          "type": "array",
          "items": { "type": "string" },
          "default": ["x-md-"]
        },
        "constants": {
          "type": "object",
          "additionalProperties": { "type": "string" }
        }
      }
    },
    "middlewareTracing": {
      "type": "object",
      "properties": {
        "disable": { "type": "boolean", "default": false },
        "tracer_name": { "type": "string" }
      }
    },
    "middlewareMetrics": {
      "type": "object",
      "properties": {
        "disable": { "type": "boolean", "default": false },
        "meter_name": { "type": "string" }
      }
    },
    "middlewareLogging": {
      "type": "object",
      "properties": {
        "disable": { "type": "boolean", "default": false }
      }
    },
    "ratelimit": {
      "type": "object",
      "description": "限流器配置",
      "properties": {
        "enable": { "type": "boolean", "default": false },
        "bbr_limiter": {
          "type": "object",
          "properties": {
            "window": { "type": "string", "default": "10s" },
            "bucket": { "type": "integer", "default": 100 },
            "cpu_threshold": { "type": "integer", "default": 800 },
            "cpu_quota": { "type": "number" }
          }
        }
      }
    },
    "circuitbreaker": {
      "type": "object",
      "description": "熔断器配置",
      "properties": {
        "enable": { "type": "boolean", "default": false },
        "sre": {
          "type": "object",
          "properties": {
            "success": { "type": "number", "default": 0.6, "description": "K = 1/Success" },
            "request": { "type": "integer", "default": 100, "description": "最小请求数" },
            "bucket": { "type": "integer", "default": 10 },
            "window": { "type": "string", "default": "3s" }
          }
        }
      }
    },
    "serverMiddleware": {
      "type": "object",
      "description": "服务端中间件配置",
      "properties": {
        "timeout": { "$ref": "#/$defs/timeout" },
        "metadata": { "$ref": "#/$defs/metadata" },
        "tracing": { "$ref": "#/$defs/middlewareTracing" },
        "metrics": { "$ref": "#/$defs/middlewareMetrics" },
        "logging": { "$ref": "#/$defs/middlewareLogging" },
        "validator": {
          "type": "object",
          "properties": {
            "disable": { "type": "boolean", "default": false }
          }
        },
        "ratelimit": { "$ref": "#/$defs/ratelimit" }
      }
    },
    "clientMiddleware": {
      "type": "object",
      "description": "客户端中间件配置",
      "properties": {
        "timeout": { "$ref": "#/$defs/timeout" },
        "metadata": { "$ref": "#/$defs/metadata" },
        "tracing": { "$ref": "#/$defs/middlewareTracing" },
        "metrics": { "$ref": "#/$defs/middlewareMetrics" },
        "logging": { "$ref": "#/$defs/middlewareLogging" },
        "circuitbreaker": { "$ref": "#/$defs/circuitbreaker" }
      }
    }
  }
}